{% extends "base.html" %}

{% block title %}Home - Sequence BioLab{% endblock %}

{% block content %}
<div class="player-home">
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-background"></div>
        <div class="hero-content">
            <div class="hero-avatar-wrapper">
                {% if current_user and current_user.profile_image_path %}
                    <img src="{{ url_for('static', filename=current_user.profile_image_path) }}" alt="{{ current_user.first_name }} {{ current_user.last_name }}" class="hero-avatar-img">
                {% else %}
                    <div class="hero-avatar-placeholder">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
            </div>
            <div class="hero-text">
                <span class="hero-badge">{{ current_user.position or "Athlete" }}</span>
                <h1 class="hero-title">Welcome, {{ current_user.first_name or current_user.email }}</h1>
            </div>
            <div class="hero-logo">
                <img src="{{ url_for('static', filename='sequence-logo.png') }}" alt="Sequence Logo" class="hero-logo-img">
            </div>
        </div>
        {% if session.get('is_admin') and admin_user_options %}
        <div class="hero-actions">
            <form class="gameday-user-picker" method="get" action="{{ url_for('home') }}" id="player-schedule-form">
                <label class="gameday-user-picker-label" for="home-user-select">View player schedule</label>
                <select id="home-user-select" name="user_id" aria-label="Select player to view schedule">
                    {% for option in admin_user_options %}
                    <option value="{{ option.id }}" {% if option.id == selected_user_id %}selected{% endif %}>{{ option.label }}</option>
                    {% endfor %}
                </select>
                <noscript>
                    <button type="submit">Apply</button>
                </noscript>
            </form>
        </div>
        {% endif %}
    </section>

    <!-- Key Info Cards -->
    <section class="info-grid">
        {% if next_series %}
        <article class="info-card info-card-featured">
            <div class="info-card-top">
                <div class="info-card-icon">
                    {% if next_series.opponent_id %}
                        <img src="https://www.mlbstatic.com/team-logos/{{ next_series.opponent_id }}.svg" 
                             alt="{{ next_series.opponent_name }} logo" 
                             class="info-card-logo"
                             loading="lazy">
                    {% else %}
                        <i class="fas fa-baseball"></i>
                    {% endif %}
                </div>
                <div class="info-card-content">
                    <span class="info-card-label">Next Opponent</span>
                    <h3>{{ next_series.opponent_name }}</h3>
                    <p>{{ next_series.start_date }} – {{ next_series.end_date }}</p>
                </div>
            </div>
            <a href="{{ url_for('gameday') }}" class="info-card-cta">
                <span>View Gameday Prep</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </article>
        {% endif %}

        <!-- Schedule Calendar Widget with Sidebar -->
        <div class="calendar-with-sidebar">
            <article class="info-card info-card-calendar">
                <header class="panel-header">
                    <h2>Schedule</h2>
                    <a href="{{ url_for('schedule') }}" class="panel-link">View full</a>
                </header>
                <div class="calendar-widget">
                    <div class="calendar-month-header" id="calendar-month-header"></div>
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">Sun</div>
                        <div class="calendar-weekday">Mon</div>
                        <div class="calendar-weekday">Tue</div>
                        <div class="calendar-weekday">Wed</div>
                        <div class="calendar-weekday">Thu</div>
                        <div class="calendar-weekday">Fri</div>
                        <div class="calendar-weekday">Sat</div>
                    </div>
                    <div class="calendar-days-grid" id="calendar-days-grid"></div>
                    <div class="calendar-legend">
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-color calendar-legend-home"></div>
                            <span>Home</span>
                        </div>
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-color calendar-legend-away"></div>
                            <span>Away</span>
                        </div>
                    </div>
                </div>
            </article>
            
            <!-- Upcoming Games Sidebar -->
            <article class="info-card info-card-upcoming">
                <header class="panel-header">
                    <h2>Upcoming Games</h2>
                </header>
                <div class="upcoming-games-list" id="upcoming-games-list">
                    <!-- Games will be populated by JavaScript -->
                </div>
            </article>
        </div>
    </section>

    <!-- Main Content Grid -->
    <section class="content-grid">
        <!-- Latest Deliverables -->
        <article class="content-panel">
            <header class="panel-header">
                <h2>Latest Reports</h2>
            </header>
            {% if deliverables %}
                <div class="deliverables-list">
                    {% for item in deliverables[:4] %}
                    <a href="{{ item.link }}" class="deliverable-item">
                        <div class="deliverable-image">
                            <div class="deliverable-image-icon">
                                <i class="{{ item.icon }}"></i>
                            </div>
                        </div>
                        <div class="deliverable-content">
                            <h4>{{ item.title }}</h4>
                            <span class="deliverable-time">{{ item.summary or item.owner }} • {{ item.time_ago }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>New reports will appear here</p>
                </div>
            {% endif %}
        </article>

        <!-- News & Media -->
        <article class="content-panel content-panel-news">
            <header class="panel-header">
                <h2>News & Updates</h2>
            </header>
            {% if player_news %}
            <div class="news-list">
                {% for news in player_news %}
                <a href="{{ news.link }}" target="_blank" rel="noopener noreferrer" class="news-item" onclick="window.open(this.href, '_blank', 'noopener,noreferrer'); return false;">
                    <div class="news-image">
                        {% if news.image %}
                            <img src="{{ news.image }}" alt="{{ news.title }}" class="news-image-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        <div class="news-image-fallback" {% if news.image %}style="display: none;"{% endif %}>
                            {% if news.type == 'player' and player_headshot_url %}
                                <img src="{{ player_headshot_url }}" alt="Player headshot" class="news-image-fallback-img" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='grid';">
                                <div class="news-image-fallback-icon" style="display: none;">
                                    <i class="fas fa-baseball-ball"></i>
                                </div>
                            {% elif news.type == 'league' and mlb_logo_url %}
                                <img src="{{ mlb_logo_url }}" alt="MLB" class="news-image-fallback-img news-image-fallback-logo" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='grid';">
                                <div class="news-image-fallback-icon" style="display: none;">
                                    <i class="fas fa-baseball-ball"></i>
                                </div>
                            {% else %}
                                <div class="news-image-fallback-icon">
                                    <i class="fas fa-baseball-ball"></i>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="news-content">
                        <h4>{{ news.title }}</h4>
                        <span class="news-time">{{ news.time_ago }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-newspaper"></i>
                <p>No recent news available</p>
            </div>
            {% endif %}
        </article>

    </section>
</div>
{% endblock %}

{% block scripts %}
<style>
.player-home {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 32px 64px;
    display: grid;
    gap: 40px;
}

/* Hero Section */
.hero-section {
    position: relative;
    border-radius: 32px;
    overflow-x: hidden;
    overflow-y: visible;
    background: linear-gradient(135deg, rgba(255, 127, 0, 0.12), rgba(255, 149, 0, 0.06));
    border: 1px solid rgba(255, 127, 0, 0.2);
    padding: 48px 40px;
    margin-top: 24px;
}

.hero-background {
    position: absolute;
    inset: 0;
    background: 
        radial-gradient(circle at 20% 50%, rgba(255, 127, 0, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(255, 149, 0, 0.06) 0%, transparent 50%);
    pointer-events: none;
}

.hero-content {
    position: relative;
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 32px;
    z-index: 1;
}

.hero-avatar-wrapper {
    width: 100px;
    height: 100px;
    border-radius: 24px;
    overflow: hidden;
    border: 3px solid rgba(255, 127, 0, 0.3);
    box-shadow: 0 8px 32px rgba(255, 127, 0, 0.2);
    background: var(--color-layer-soft);
}

.hero-avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.hero-avatar-placeholder {
    width: 100%;
    height: 100%;
    display: grid;
    place-items: center;
    font-size: 2.5rem;
    color: var(--color-accent);
}

.hero-text {
    display: grid;
    gap: 8px;
}

.hero-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 16px;
    border-radius: 999px;
    background: rgba(255, 127, 0, 0.15);
    color: var(--color-accent);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    width: fit-content;
    border: 1px solid rgba(255, 127, 0, 0.3);
}

.hero-title {
    margin: 0;
    font-size: clamp(2rem, 4vw, 2.75rem);
    font-weight: 800;
    color: var(--color-text-primary);
    line-height: 1.1;
    letter-spacing: -0.02em;
}


.hero-subtitle {
    margin: 0;
    font-size: 1.1rem;
    color: var(--color-text-secondary);
    font-weight: 500;
}

.hero-action {
    display: flex;
    align-items: center;
}

.hero-cta {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 16px 32px;
    border-radius: 16px;
    background: linear-gradient(135deg, var(--color-accent), var(--color-accent-bright));
    color: var(--color-text-inverse);
    font-weight: 700;
    font-size: 1rem;
    text-decoration: none;
    box-shadow: 0 8px 24px rgba(255, 127, 0, 0.35);
    transition: all 0.3s ease;
    border: none;
}

.hero-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(255, 127, 0, 0.45);
}

.hero-cta i {
    transition: transform 0.3s ease;
}

.hero-cta:hover i {
    transform: translateX(4px);
}

.hero-skeleton {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.4;
    transition: opacity 0.3s ease;
}

.hero-skeleton:hover {
    opacity: 0.6;
}

.hero-skeleton-svg {
    width: 120px;
    height: 120px;
    filter: drop-shadow(0 0 8px rgba(255, 127, 0, 0.3));
}

.hero-logo {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    opacity: 0.9;
    transition: opacity 0.3s ease;
}

.hero-logo:hover {
    opacity: 1;
}

.hero-logo-img {
    max-width: 300px;
    max-height: 120px;
    width: auto;
    height: auto;
    object-fit: contain;
}

.hero-actions {
    position: relative;
    z-index: 1;
    margin-top: 24px;
    display: flex;
    justify-content: flex-start;
    overflow: visible;
}

.hero-section .gameday-user-picker {
    background: var(--color-layer);
    border: 1px solid var(--color-layer-border);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.hero-section .gameday-user-picker {
    position: relative;
}

.hero-section .gameday-user-picker .custom-select-wrapper {
    min-width: 250px;
    max-width: 350px;
    position: relative !important;
    display: block !important;
    width: 100% !important;
    z-index: 10000 !important;
    overflow: visible !important;
}

.hero-section .gameday-user-picker .custom-select {
    width: 100% !important;
    min-width: 250px !important;
    max-width: 350px !important;
    padding: 8px 12px !important;
    background: var(--color-layer-input) !important;
    border: 1px solid var(--color-layer-border) !important;
    border-radius: 8px !important;
    color: var(--color-text-primary) !important;
    font-size: 0.95rem !important;
    font-weight: 500 !important;
    min-height: 44px !important;
}

.hero-section .gameday-user-picker .custom-select:hover {
    border-color: rgba(255, 127, 0, 0.3) !important;
}

.hero-section .gameday-user-picker .custom-select.open {
    border-color: var(--color-accent) !important;
    border-radius: 8px 8px 0 0 !important;
}

.hero-section .gameday-user-picker .custom-select-dropdown {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    min-width: 250px !important;
    max-width: 350px !important;
    width: 100% !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    z-index: 10001 !important;
    background: var(--color-layer) !important;
    border: 1px solid var(--color-layer-border) !important;
    border-top: none !important;
    border-radius: 0 0 8px 8px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    display: none !important;
    overscroll-behavior: contain !important;
}

.hero-section .gameday-user-picker .custom-select-dropdown.open {
    display: block !important;
}

.hero-section .gameday-user-picker .custom-select-option {
    white-space: nowrap !important;
    overflow: visible !important;
    text-overflow: ellipsis !important;
    padding: 10px 12px !important;
    min-height: 44px !important;
    display: flex !important;
    align-items: center !important;
    width: 100% !important;
    box-sizing: border-box !important;
    flex-shrink: 0 !important;
}

/* Ensure scrollbar is visible and always shows when content overflows */
.hero-section .gameday-user-picker .custom-select-dropdown {
    scrollbar-width: thin !important;
    scrollbar-color: var(--color-text-subtle) var(--color-layer-soft) !important;
}

.hero-section .gameday-user-picker .custom-select-dropdown::-webkit-scrollbar {
    width: 8px !important;
    display: block !important;
    -webkit-appearance: none !important;
}

.hero-section .gameday-user-picker .custom-select-dropdown::-webkit-scrollbar-track {
    background: var(--color-layer-soft) !important;
    border-radius: 4px !important;
    -webkit-box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.1) !important;
}

.hero-section .gameday-user-picker .custom-select-dropdown::-webkit-scrollbar-thumb {
    background: var(--color-text-subtle) !important;
    border-radius: 4px !important;
    min-height: 20px !important;
    -webkit-box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.2) !important;
}

.hero-section .gameday-user-picker .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-secondary) !important;
}

/* Info Grid */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
}

.info-card {
    background: var(--color-layer);
    border: 1px solid var(--color-layer-border);
    border-radius: 24px;
    padding: 28px;
    display: flex;
    gap: 20px;
    align-items: flex-start;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.info-card-calendar,
.info-card-upcoming {
    overflow: visible;
}

.info-card:has(.info-card-cta) {
    flex-direction: column;
    gap: 20px;
}

.info-card-featured {
    flex-direction: column;
    gap: 20px;
    grid-column: 1 / -1;
}

.info-card::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 127, 0, 0.05), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.info-card:hover {
    border-color: rgba(255, 127, 0, 0.4);
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
}

.info-card:hover::before {
    opacity: 1;
}

.info-card-featured {
    background: linear-gradient(135deg, rgba(255, 127, 0, 0.08), rgba(255, 149, 0, 0.04));
    border-color: rgba(255, 127, 0, 0.3);
    flex-direction: column;
    gap: 20px;
}

.info-card-top {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    width: 100%;
}

.info-card-featured .info-card-content {
    flex: 1;
}

.info-card-icon {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    background: linear-gradient(135deg, rgba(255, 127, 0, 0.2), rgba(255, 149, 0, 0.1));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
    font-size: 1.5rem;
    flex-shrink: 0;
    border: 1px solid rgba(255, 127, 0, 0.2);
    padding: 8px;
}

.info-card-logo {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.info-card-content {
    flex: 1;
    display: grid;
    gap: 8px;
    position: relative;
    z-index: 1;
}

.info-card-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-subtle);
}

.info-card-content h3 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--color-text-primary);
    line-height: 1.2;
}

.info-card-content p {
    margin: 0;
    color: var(--color-text-secondary);
    font-size: 0.95rem;
}

.info-card-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    border-radius: 999px;
    background: rgba(255, 127, 0, 0.15);
    color: var(--color-accent);
    font-size: 0.8rem;
    font-weight: 600;
    width: fit-content;
    margin-top: 4px;
}

.info-card-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--color-accent);
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
    margin-top: 4px;
    transition: gap 0.3s ease;
}

.info-card-link:hover {
    gap: 10px;
}

.info-card-link i {
    font-size: 0.75rem;
    transition: transform 0.3s ease;
}

.info-card-link:hover i {
    transform: translateX(4px);
}

.info-card-cta {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 14px 24px;
    border-radius: 14px;
    background: linear-gradient(135deg, var(--color-accent), var(--color-accent-bright));
    color: var(--color-text-inverse);
    font-weight: 700;
    font-size: 0.95rem;
    text-decoration: none;
    box-shadow: 0 6px 20px rgba(255, 127, 0, 0.35);
    transition: all 0.3s ease;
    width: fit-content;
    margin-top: 8px;
    cursor: pointer;
    position: relative;
    z-index: 10;
}

.info-card-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 127, 0, 0.45);
}

.info-card-cta i {
    font-size: 0.9rem;
    transition: transform 0.3s ease;
}

.info-card-cta:hover i {
    transform: translateX(4px);
}

/* Content Grid */
.content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
    gap: 32px;
}

.content-panel {
    background: var(--color-layer);
    border: 1px solid var(--color-layer-border);
    border-radius: 24px;
    padding: 32px;
    display: grid;
    gap: 24px;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
}

.panel-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-primary);
}

.panel-link {
    color: var(--color-text-subtle);
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    transition: color 0.3s ease;
    cursor: pointer;
    position: relative;
    z-index: 10;
}

.panel-link:hover {
    color: var(--color-accent);
}

/* Deliverables */
.deliverables-list {
    display: grid;
    gap: 20px;
}

.deliverable-item {
    display: flex;
    gap: 16px;
    padding: 16px;
    border-radius: 16px;
    background: var(--color-layer-soft);
    border: 1px solid var(--color-layer-border);
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
    align-items: center;
    height: 112px;
    box-sizing: border-box;
}

.deliverable-item:hover {
    border-color: var(--color-layer-border);
    transform: translateX(4px);
    background: var(--color-layer-soft);
}

.deliverable-image {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    background: var(--color-layer);
    display: grid;
    place-items: center;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid var(--color-layer-border);
}

.deliverable-image-icon {
    width: 100%;
    height: 100%;
    display: grid;
    place-items: center;
    background: linear-gradient(135deg, rgba(255, 127, 0, 0.2), rgba(255, 149, 0, 0.1));
    color: var(--color-accent);
    font-size: 2rem;
    opacity: 0.8;
}

.deliverable-content {
    flex: 1;
    display: grid;
    gap: 8px;
    min-width: 0;
    overflow: hidden;
}

.deliverable-content h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.deliverable-time {
    font-size: 0.85rem;
    color: var(--color-text-subtle);
}

/* News Section */
.content-panel-news {
    background: var(--color-layer);
}

.news-list {
    display: grid;
    gap: 20px;
}

.news-item {
    display: flex;
    gap: 16px;
    padding: 16px;
    border-radius: 16px;
    background: var(--color-layer-soft);
    border: 1px solid var(--color-layer-border);
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
    align-items: center;
    height: 112px;
    box-sizing: border-box;
}

.news-item:hover {
    border-color: var(--color-layer-border);
    transform: translateX(4px);
    background: var(--color-layer-soft);
}

.news-image {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    background: var(--color-layer);
    display: grid;
    place-items: center;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid var(--color-layer-border);
}

.news-image-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.news-image-fallback {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(255, 127, 0, 0.2), rgba(255, 149, 0, 0.1));
    overflow: hidden;
    position: relative;
}

.news-image-fallback-img {
    width: 100%;
    height: 120%;
    object-fit: cover;
    object-position: center center;
    transform: translateY(-2%);
}

.news-image-fallback-logo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center center;
    transform: none;
}

.news-image-fallback-icon {
    width: 100%;
    height: 100%;
    display: grid;
    place-items: center;
    font-size: 2rem;
    color: var(--color-accent);
    opacity: 0.8;
}

.news-content {
    flex: 1;
    display: grid;
    gap: 8px;
    min-width: 0;
    overflow: hidden;
}

.news-content h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.news-time {
    font-size: 0.85rem;
    color: var(--color-text-subtle);
}

/* Calendar Widget with Sidebar */
.calendar-with-sidebar {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
}

.info-card-calendar {
    width: 100%;
    display: flex;
    flex-direction: column;
}

.calendar-widget {
    margin-top: 20px;
    width: 100%;
    display: flex;
    flex-direction: column;
}

.calendar-month-header {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: 16px;
    text-align: center;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 8px;
}

.calendar-weekday {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-subtle);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 8px 4px;
}

.calendar-days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 3px 3px 3px 3px;
    border-radius: 8px;
    background: var(--color-layer-soft);
    border: 1px solid var(--color-layer-border);
    position: relative;
    transition: all 0.2s ease;
    min-height: 48px;
    overflow: hidden;
}

.calendar-day.other-month {
    opacity: 0.3;
}

.calendar-day.today {
    background: rgba(255, 127, 0, 0.2);
    border: 2px solid var(--color-accent);
    border-color: var(--color-accent);
    font-weight: 700;
    box-shadow: 0 0 0 2px rgba(255, 127, 0, 0.3), 0 2px 8px rgba(255, 127, 0, 0.4);
    position: relative;
}

.calendar-day.today::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border: 2px solid var(--color-accent);
    border-radius: 8px;
    opacity: 0.5;
    pointer-events: none;
}

.calendar-day.today .calendar-day-number {
    font-weight: 800;
    font-size: 0.85rem;
    color: var(--color-accent);
}

.calendar-day.has-game {
    cursor: pointer;
}

.calendar-day.has-game:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.calendar-day.has-game.game-home {
    background: rgba(255, 127, 0, 0.15);
    border-color: rgba(255, 127, 0, 0.4);
}

.calendar-day.has-game.game-away {
    background: rgba(100, 150, 255, 0.15);
    border-color: rgba(100, 150, 255, 0.4);
}

.calendar-day.has-game.today.game-home {
    background: rgba(255, 127, 0, 0.3);
    border: 2px solid var(--color-accent);
    box-shadow: 0 0 0 2px rgba(255, 127, 0, 0.4), 0 2px 8px rgba(255, 127, 0, 0.5);
}

.calendar-day.has-game.today.game-away {
    background: rgba(100, 150, 255, 0.3);
    border: 2px solid var(--color-accent);
    box-shadow: 0 0 0 2px rgba(255, 127, 0, 0.4), 0 2px 8px rgba(255, 127, 0, 0.5);
}

.calendar-day-number {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
    z-index: 1;
    align-self: flex-start;
    width: 100%;
    text-align: left;
    padding-left: 2px;
    line-height: 1;
}

.calendar-team-logo {
    width: 36px;
    height: 36px;
    max-width: 36px;
    max-height: 36px;
    object-fit: contain;
    z-index: 2;
    opacity: 1;
    display: block;
    align-self: center;
    margin-top: auto;
    flex-shrink: 0;
}

.calendar-game-indicator {
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.65rem;
    color: var(--color-accent);
    z-index: 1;
}

.calendar-legend {
    display: flex;
    gap: 20px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--color-layer-border);
    justify-content: center;
}

.calendar-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: var(--color-text-subtle);
}

.calendar-legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    border: 1px solid;
}

.calendar-legend-home {
    background: rgba(255, 127, 0, 0.15);
    border-color: rgba(255, 127, 0, 0.4);
}

.calendar-legend-away {
    background: rgba(100, 150, 255, 0.15);
    border-color: rgba(100, 150, 255, 0.4);
}

/* Empty State */
.empty-state {
    padding: 48px 24px;
    text-align: center;
    color: var(--color-text-muted);
}

.empty-state i {
    font-size: 3rem;
    color: var(--color-text-subtle);
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state p {
    margin: 0;
    font-size: 0.95rem;
}

/* Upcoming Games Sidebar */
.info-card-upcoming {
    width: 100%;
    height: fit-content;
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 24px;
    max-height: calc(100vh - 200px);
}

.upcoming-games-list {
    display: grid;
    gap: 16px;
    margin-top: 20px;
    overflow-y: auto;
    max-height: calc(100vh - 350px);
}

.upcoming-game-item {
    display: flex;
    gap: 12px;
    padding: 16px;
    border-radius: 12px;
    background: var(--color-layer-soft);
    border: 1px solid var(--color-layer-border);
    transition: all 0.3s ease;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
}

.upcoming-game-item:hover {
    border-color: rgba(255, 127, 0, 0.4);
    transform: translateX(4px);
    background: var(--color-layer-soft);
}

.upcoming-game-date {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 50px;
    padding: 8px;
    border-radius: 8px;
    background: var(--color-layer);
    border: 1px solid var(--color-layer-border);
}

.upcoming-game-day {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-text-subtle);
    letter-spacing: 0.05em;
}

.upcoming-game-number {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--color-text-primary);
    line-height: 1;
    margin-top: 4px;
}

.upcoming-game-details {
    flex: 1;
    display: grid;
    gap: 6px;
}

.upcoming-game-matchup {
    display: flex;
    align-items: center;
    gap: 8px;
}

.upcoming-game-vs {
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
}

.upcoming-game-vs.home {
    background: rgba(255, 127, 0, 0.2);
    color: var(--color-accent);
}

.upcoming-game-vs.away {
    background: rgba(100, 150, 255, 0.2);
    color: rgba(100, 150, 255, 1);
}

.upcoming-game-opponent {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.upcoming-game-venue {
    font-size: 0.85rem;
    color: var(--color-text-subtle);
    display: flex;
    align-items: center;
    gap: 6px;
}

.upcoming-game-venue i {
    font-size: 0.75rem;
}

.upcoming-game-empty {
    padding: 32px 16px;
    text-align: center;
    color: var(--color-text-muted);
    font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 1024px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
    
    .calendar-with-sidebar {
        grid-template-columns: 1fr;
    }
    
    .info-card-upcoming {
        position: static;
    }
}

@media (max-width: 768px) {
    .player-home {
        padding: 0 20px 48px;
        gap: 32px;
    }

    .hero-section {
        padding: 32px 24px;
        border-radius: 24px;
    }

    .hero-content {
        grid-template-columns: 1fr;
        gap: 24px;
        text-align: center;
    }

    .hero-avatar-wrapper {
        margin: 0 auto;
    }

    .hero-action {
        justify-content: center;
    }

    .hero-cta {
        width: 100%;
        justify-content: center;
    }

    .hero-skeleton {
        display: none;
    }

    .hero-logo {
        display: none;
    }

    .info-grid {
        grid-template-columns: 1fr;
    }

    .content-panel {
        padding: 24px;
    }
}

@media (max-width: 480px) {
    .player-home {
        padding: 0 16px 32px;
    }

    .hero-section {
        padding: 24px 20px;
    }

    .hero-title {
        font-size: 1.75rem;
    }

    .content-panel {
        padding: 20px;
    }
}
</style>
<script>
// Calendar widget initialization
(function() {
    // Team abbreviation to MLB team ID mapping
    const TEAM_ABBR_TO_ID = {
        "ARI": 109, "ATL": 144, "BAL": 110, "BOS": 111, "CHC": 112, "CWS": 145, "CIN": 113,
        "CLE": 114, "COL": 115, "DET": 116, "HOU": 117, "KC": 118, "LAA": 108, "LAD": 119,
        "MIA": 146, "MIL": 158, "MIN": 142, "NYM": 121, "NYY": 147, "OAK": 133, "PHI": 143,
        "PIT": 134, "SD": 135, "SF": 137, "SEA": 136, "STL": 138, "TB": 139, "TEX": 140,
        "TOR": 141, "WSH": 120, "WSN": 120, "WAS": 120
    };
    
    // Use real schedule data from backend
    const scheduleCalendar = {{ schedule_calendar|tojson|safe }} || [];
    
    console.log('Schedule calendar data received:', scheduleCalendar);
    console.log('Number of games:', scheduleCalendar.length);
    
    // Create a map of dates to games
    const gamesByDate = {};
    scheduleCalendar.forEach(game => {
        if (game && game.date) {
            gamesByDate[game.date] = game;
            console.log('Added game to map:', game.date, game.opponent, game.opponent_id, game.opponent_abbr);
        }
    });
    
    console.log('Games by date map:', gamesByDate);
    
    // Get current month based on today's date
    const today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();
    const currentDate = today.getDate();
    
    // Set month header
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    const monthHeader = document.getElementById('calendar-month-header');
    if (monthHeader) {
        monthHeader.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    }
    
    // Get first day of month and number of days
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Render calendar
    const container = document.getElementById('calendar-days-grid');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'calendar-day other-month';
        container.appendChild(emptyDiv);
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        // Format date as YYYY-MM-DD to match game dates
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const game = gamesByDate[dateStr];
        const isToday = day === currentDate && currentMonth === today.getMonth() && currentYear === today.getFullYear();
        
        // Debug: log game matching
        if (game) {
            console.log('Found game for date:', dateStr, game);
        }
        
        // Debug: log if game found but no logo
        if (game && !game.opponent_id && !game.opponent_abbr) {
            console.warn('Game found but missing team ID/abbr:', dateStr, game);
        }
        
        const dayDiv = document.createElement('div');
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (game) {
            classes += ' has-game';
            if (game.is_home) {
                classes += ' game-home';
            } else {
                classes += ' game-away';
            }
        }
        
        dayDiv.className = classes;
        
        // Make clickable if there's a game
        if (game) {
            dayDiv.style.cursor = 'pointer';
            dayDiv.addEventListener('click', function() {
                window.location.href = `{{ url_for('gameday') }}?date=${dateStr}`;
            });
        }
        
        // Get team ID for logo
        let logoHtml = '';
        if (game) {
            const teamId = game.opponent_id || (game.opponent_abbr && TEAM_ABBR_TO_ID[game.opponent_abbr.toUpperCase()]);
            if (teamId) {
                const logoUrl = `https://www.mlbstatic.com/team-logos/${teamId}.svg`;
                logoHtml = `<img src="${logoUrl}" 
                                 alt="${game.opponent}" 
                                 class="calendar-team-logo"
                                 title="${game.is_home ? 'vs' : '@'} ${game.opponent}"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.style.display='none'; const fallback = this.parentElement.querySelector('.calendar-game-indicator-fallback'); if (fallback) fallback.style.display='flex';">
                                 <div class="calendar-game-indicator calendar-game-indicator-fallback" style="display:none;" title="${game.is_home ? 'vs' : '@'} ${game.opponent}"><i class="fas fa-baseball"></i></div>`;
            } else {
                logoHtml = `<div class="calendar-game-indicator" title="${game.is_home ? 'vs' : '@'} ${game.opponent}"><i class="fas fa-baseball"></i></div>`;
            }
        }
        
        dayDiv.innerHTML = `
            <div class="calendar-day-number">${day}</div>
            ${logoHtml}
        `;
        
        container.appendChild(dayDiv);
    }
    
    // Fill remaining cells to complete the grid (next month's days)
    const totalCells = startingDayOfWeek + daysInMonth;
    const remainingCells = 7 - (totalCells % 7);
    if (remainingCells < 7) {
        for (let i = 0; i < remainingCells; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day other-month';
            container.appendChild(emptyDiv);
        }
    }
    
    // Populate upcoming games sidebar
    const upcomingGamesList = document.getElementById('upcoming-games-list');
    if (upcomingGamesList && scheduleCalendar && scheduleCalendar.length > 0) {
        // Get today's date
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Filter and sort upcoming games (next 7 days)
        const upcomingGames = scheduleCalendar
            .filter(game => {
                if (!game || !game.date) return false;
                const gameDate = new Date(game.date + 'T00:00:00');
                gameDate.setHours(0, 0, 0, 0);
                return gameDate >= today;
            })
            .sort((a, b) => {
                const dateA = new Date(a.date + 'T00:00:00');
                const dateB = new Date(b.date + 'T00:00:00');
                return dateA - dateB;
            })
            .slice(0, 5); // Show next 5 games
        
        if (upcomingGames.length === 0) {
            upcomingGamesList.innerHTML = '<div class="upcoming-game-empty">No upcoming games scheduled</div>';
        } else {
            upcomingGamesList.innerHTML = '';
            
            upcomingGames.forEach(game => {
                const gameDate = new Date(game.date + 'T00:00:00');
                const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const dayName = dayNames[gameDate.getDay()];
                const dayNumber = gameDate.getDate();
                
                const gameItem = document.createElement('a');
                gameItem.className = 'upcoming-game-item';
                gameItem.href = `{{ url_for('gameday') }}?date=${game.date}`;
                
                const vsClass = game.is_home ? 'home' : 'away';
                const vsText = game.is_home ? 'VS' : '@';
                const opponent = game.opponent || game.opponent_name || 'TBD';
                const venue = game.venue || 'TBD';
                
                // Create date container
                const dateContainer = document.createElement('div');
                dateContainer.className = 'upcoming-game-date';
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'upcoming-game-day';
                dayDiv.textContent = dayName;
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'upcoming-game-number';
                numberDiv.textContent = dayNumber;
                
                dateContainer.appendChild(dayDiv);
                dateContainer.appendChild(numberDiv);
                
                // Create details container
                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'upcoming-game-details';
                
                // Create matchup
                const matchupDiv = document.createElement('div');
                matchupDiv.className = 'upcoming-game-matchup';
                
                const vsSpan = document.createElement('span');
                vsSpan.className = `upcoming-game-vs ${vsClass}`;
                vsSpan.textContent = vsText;
                
                const opponentSpan = document.createElement('span');
                opponentSpan.className = 'upcoming-game-opponent';
                opponentSpan.textContent = opponent;
                
                matchupDiv.appendChild(vsSpan);
                matchupDiv.appendChild(opponentSpan);
                
                // Create venue
                const venueDiv = document.createElement('div');
                venueDiv.className = 'upcoming-game-venue';
                
                const venueIcon = document.createElement('i');
                venueIcon.className = 'fas fa-location-dot';
                venueDiv.appendChild(venueIcon);
                
                const venueText = document.createTextNode(` ${venue}`);
                venueDiv.appendChild(venueText);
                
                detailsContainer.appendChild(matchupDiv);
                detailsContainer.appendChild(venueDiv);
                
                gameItem.appendChild(dateContainer);
                gameItem.appendChild(detailsContainer);
                
                upcomingGamesList.appendChild(gameItem);
            });
        }
    } else if (upcomingGamesList) {
        upcomingGamesList.innerHTML = '<div class="upcoming-game-empty">No upcoming games scheduled</div>';
    }
})();

// Handle player schedule form submission and ensure dropdown works
document.addEventListener('DOMContentLoaded', function() {
    const playerSelect = document.getElementById('home-user-select');
    const playerForm = document.getElementById('player-schedule-form');
    
    if (playerSelect && playerForm) {
        // Wait for custom select to be enhanced, then add change handler
        setTimeout(function() {
            playerSelect.addEventListener('change', function() {
                playerForm.submit();
            });
            
            // Ensure dropdown shows all options and is scrollable
            const wrapper = playerSelect.closest('.custom-select-wrapper');
            if (wrapper) {
                const dropdown = wrapper.querySelector('.custom-select-dropdown');
                const customSelect = wrapper.querySelector('.custom-select');
                
                if (dropdown) {
                    // Ensure dropdown can escape overflow constraints
                    dropdown.style.position = 'absolute';
                    dropdown.style.zIndex = '10001';
                    dropdown.style.maxHeight = '300px';
                    dropdown.style.overflowY = 'auto';
                    dropdown.style.overflowX = 'hidden';
                    
                    // Make wrapper allow overflow for dropdown
                    wrapper.style.overflow = 'visible';
                    wrapper.style.zIndex = '10000';
                    
                    // Ensure all options are visible and not clipped
                    const ensureOptionsVisible = function() {
                    const options = dropdown.querySelectorAll('.custom-select-option');
                    options.forEach(function(option) {
                        option.style.display = 'flex';
                        option.style.visibility = 'visible';
                        option.style.opacity = '1';
                            option.style.flexShrink = '0';
                            option.style.minHeight = '44px';
                    });
                    };
                    
                    // Check when dropdown opens
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                                if (dropdown.classList.contains('open')) {
                                    ensureOptionsVisible();
                                    // Scroll selected option into view
                                    const selected = dropdown.querySelector('.custom-select-option.selected');
                                    if (selected) {
                                        selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                                    }
                                }
                            }
                        });
                    });
                    
                    observer.observe(dropdown, { attributes: true });
                    ensureOptionsVisible();
                }
            }
        }, 300);
    }
});

document.addEventListener('click', async (event) => {
    const button = event.target.closest('[data-action="acknowledge"]');
    if (!button) return;
    const deliverableId = button.dataset.deliverableId;
    if (!deliverableId) return;

    button.disabled = true;
    button.textContent = 'Saving…';

    try {
        const response = await fetch(`/api/player/deliverables/${deliverableId}/acknowledge`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
        });
        if (!response.ok) throw new Error('Request failed');
        button.textContent = 'Acknowledged';
        button.classList.add('btn-secondary');
        button.classList.remove('btn-primary');
    } catch (err) {
        button.textContent = 'Try again';
        button.disabled = false;
    }
});
</script>
{% endblock %}

