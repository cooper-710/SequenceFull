{% extends "base.html" %}

{% block title %}Schedule - Sequence BioLab{% endblock %}

{% block content %}
<div class="page-container schedule-page">
    <header class="section-hero">
        <div class="section-hero-heading">
            <h1 class="hero-content">Schedule</h1>
        </div>
        {% if session.get('is_admin') and admin_user_options %}
        <form class="section-hero-actions gameday-user-picker" method="get" action="{{ url_for('schedule') }}" id="schedule-user-form">
            {% set month = request.args.get('month') %}
            {% set year = request.args.get('year') %}
            {% if month %}
            <input type="hidden" name="month" value="{{ month }}">
            {% endif %}
            {% if year %}
            <input type="hidden" name="year" value="{{ year }}">
            {% endif %}
            <label class="gameday-user-picker-label" for="schedule-user-select">View player schedule</label>
            <select id="schedule-user-select" name="user_id" class="gameday-user-picker-select" aria-label="Select player to view schedule" onchange="this.form.submit()">
                {% for option in admin_user_options %}
                <option value="{{ option.id }}" {% if option.id == selected_user_id %}selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
            </select>
            <noscript>
                <button type="submit">Apply</button>
            </noscript>
        </form>
        {% endif %}
    </header>
    
    <!-- Month Navigation -->
    <div class="schedule-navigation">
        {% if selected_user_id %}
            <a href="{{ url_for('schedule', month=prev_month, year=prev_year, user_id=selected_user_id) }}" class="schedule-nav-btn">
        {% else %}
        <a href="{{ url_for('schedule', month=prev_month, year=prev_year) }}" class="schedule-nav-btn">
        {% endif %}
            <i class="fas fa-chevron-left"></i>
            <span>{{ month_names[prev_month - 1] }} {{ prev_year }}</span>
        </a>
        
        <div class="schedule-month-selector">
            <div class="schedule-month-display">{{ month_name }} {{ current_year }}</div>
        </div>
        
        {% if selected_user_id %}
            <a href="{{ url_for('schedule', month=next_month, year=next_year, user_id=selected_user_id) }}" class="schedule-nav-btn">
        {% else %}
        <a href="{{ url_for('schedule', month=next_month, year=next_year) }}" class="schedule-nav-btn">
        {% endif %}
            <span>{{ month_names[next_month - 1] }} {{ next_year }}</span>
            <i class="fas fa-chevron-right"></i>
        </a>
    </div>
    
    <!-- Schedule Content -->
    <section class="content-panel">
        <header class="panel-header">
            <h2>{{ month_name }} {{ current_year }}</h2>
        </header>
        
        <!-- Calendar View -->
        <div class="schedule-calendar-container">
            <div class="calendar-widget">
                <div class="calendar-weekdays">
                    <div class="calendar-weekday">SUN</div>
                    <div class="calendar-weekday">MON</div>
                    <div class="calendar-weekday">TUE</div>
                    <div class="calendar-weekday">WED</div>
                    <div class="calendar-weekday">THU</div>
                    <div class="calendar-weekday">FRI</div>
                    <div class="calendar-weekday">SAT</div>
                </div>
                <div class="calendar-days-grid" id="schedule-calendar-days-grid"></div>
                <div class="calendar-legend">
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color calendar-legend-home"></div>
                        <span>Home</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color calendar-legend-away"></div>
                        <span>Away</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Details List (shown below calendar) -->
        {% if games_by_date %}
            <div class="schedule-list">
                <h3 class="schedule-list-title">Game Details</h3>
                {% for date_key in games_by_date|sort %}
                    {% set date_info = games_by_date[date_key] %}
                    {% set games = date_info.games %}
                    
                    <div class="schedule-date-group">
                        <div class="schedule-date-header">
                            <div class="schedule-date-info">
                                <span class="schedule-day-name">{{ date_info.day_name }}</span>
                                <span class="schedule-date-full">{{ date_info.date_formatted }}</span>
                            </div>
                        </div>
                        
                        <div class="schedule-games">
                            {% for game in games %}
                                <div class="schedule-game-item">
                                    <div class="schedule-game-time">
                                        {{ game.time_formatted or 'TBD' }}
                                    </div>
                                    
                                    <div class="schedule-game-details">
                                        <div class="schedule-game-matchup">
                                            {% if game.is_home %}
                                                <span class="schedule-vs-badge home">vs</span>
                                            {% else %}
                                                <span class="schedule-vs-badge away">@</span>
                                            {% endif %}
                                            <span class="schedule-opponent-name">{{ game.opponent_name }}</span>
                                        </div>
                                        
                                        {% if game.venue %}
                                            <div class="schedule-game-venue">
                                                <i class="fas fa-location-dot"></i>
                                                {{ game.venue }}
                                            </div>
                                        {% endif %}
                                        
                                        {% if game.status and game.status != 'Scheduled' %}
                                            <div class="schedule-game-status">
                                                <span class="status-badge status-{{ game.status.lower().replace(' ', '-') }}">
                                                    {{ game.status }}
                                                </span>
                                            </div>
                                        {% endif %}
                                        
                                        {% if game.probable_pitchers and game.probable_pitchers|length > 0 %}
                                            <div class="schedule-game-pitchers">
                                                <i class="fas fa-user"></i>
                                                Probable: {{ game.probable_pitchers[0].name if game.probable_pitchers[0].name else 'TBD' }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </section>
</div>

<script>
// Calendar rendering
(function() {
    // Team abbreviation to MLB team ID mapping
    const TEAM_ABBR_TO_ID = {
        "ARI": 109, "ATL": 144, "BAL": 110, "BOS": 111, "CHC": 112, "CWS": 145, "CIN": 113,
        "CLE": 114, "COL": 115, "DET": 116, "HOU": 117, "KC": 118, "LAA": 108, "LAD": 119,
        "MIA": 146, "MIL": 158, "MIN": 142, "NYM": 121, "NYY": 147, "OAK": 133, "PHI": 143,
        "PIT": 134, "SD": 135, "SF": 137, "SEA": 136, "STL": 138, "TB": 139, "TEX": 140,
        "TOR": 141, "WSH": 120, "WSN": 120, "WAS": 120
    };
    
    // Convert games_by_date from template to JavaScript format
    const gamesByDate = {};
    {% if games_by_date %}
        {% for date_key, date_info in games_by_date.items() %}
            {% if date_info.games and date_info.games|length > 0 %}
                {% set game = date_info.games[0] %}
                gamesByDate['{{ date_key }}'] = {
                    date: '{{ date_key }}',
                    opponent: '{{ game.opponent_name|e }}',
                    opponent_id: {{ game.opponent_id|default('null') }},
                    opponent_abbr: '{{ game.opponent_abbr|default("") }}',
                    is_home: {{ 'true' if game.is_home else 'false' }},
                    venue: '{{ game.venue|default("")|e }}',
                    time_formatted: '{{ game.time_formatted|default("TBD")|e }}'
                };
            {% endif %}
        {% endfor %}
    {% endif %}
    
    // Get current month from template variables
    const currentMonth = {{ current_month - 1 }}; // JavaScript months are 0-indexed
    const currentYear = {{ current_year }};
    
    // Get today's date for highlighting
    const today = new Date();
    const todayDate = today.getDate();
    const todayMonth = today.getMonth();
    const todayYear = today.getFullYear();
    
    // Get first day of month and number of days
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Render calendar
    const container = document.getElementById('schedule-calendar-days-grid');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'calendar-day other-month';
        container.appendChild(emptyDiv);
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        // Format date as YYYY-MM-DD to match game dates
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const game = gamesByDate[dateStr];
        const isToday = day === todayDate && currentMonth === todayMonth && currentYear === todayYear;
        
        const dayDiv = document.createElement('div');
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (game) {
            classes += ' has-game';
            if (game.is_home) {
                classes += ' game-home';
            } else {
                classes += ' game-away';
            }
        }
        
        dayDiv.className = classes;
        
        // Make clickable if there's a game
        if (game) {
            dayDiv.style.cursor = 'pointer';
            dayDiv.addEventListener('click', function() {
                window.location.href = `{{ url_for('gameday') }}?date=${dateStr}`;
            });
        }
        
        // Get team ID for logo
        let logoHtml = '';
        if (game) {
            const teamId = game.opponent_id || (game.opponent_abbr && TEAM_ABBR_TO_ID[game.opponent_abbr.toUpperCase()]);
            if (teamId) {
                const logoUrl = `https://www.mlbstatic.com/team-logos/${teamId}.svg`;
                logoHtml = `<img src="${logoUrl}" 
                                 alt="${game.opponent}" 
                                 class="calendar-team-logo"
                                 title="${game.is_home ? 'vs' : '@'} ${game.opponent}"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.style.display='none'; const fallback = this.parentElement.querySelector('.calendar-game-indicator-fallback'); if (fallback) fallback.style.display='flex';">
                                 <div class="calendar-game-indicator calendar-game-indicator-fallback" style="display:none;" title="${game.is_home ? 'vs' : '@'} ${game.opponent}"><i class="fas fa-baseball"></i></div>`;
            } else {
                logoHtml = `<div class="calendar-game-indicator" title="${game.is_home ? 'vs' : '@'} ${game.opponent}"><i class="fas fa-baseball"></i></div>`;
            }
        }
        
        dayDiv.innerHTML = `
            <div class="calendar-day-number">${day}</div>
            ${logoHtml}
        `;
        
        container.appendChild(dayDiv);
    }
    
    // Fill remaining cells to complete the grid (next month's days)
    const totalCells = startingDayOfWeek + daysInMonth;
    const remainingCells = 7 - (totalCells % 7);
    if (remainingCells < 7) {
        for (let i = 0; i < remainingCells; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day other-month';
            container.appendChild(emptyDiv);
        }
    }
})();

// Handle schedule user form submission and ensure dropdown works
document.addEventListener('DOMContentLoaded', function() {
    const scheduleSelect = document.getElementById('schedule-user-select');
    const scheduleForm = document.getElementById('schedule-user-form');
    
    if (scheduleSelect && scheduleForm) {
        // Wait for custom select to be enhanced, then add change handler
        setTimeout(function() {
            scheduleSelect.addEventListener('change', function() {
                scheduleForm.submit();
            });
            
            // Ensure dropdown shows all options and is scrollable
            const wrapper = scheduleSelect.closest('.custom-select-wrapper');
            if (wrapper) {
                const dropdown = wrapper.querySelector('.custom-select-dropdown');
                
                if (dropdown) {
                    // Ensure dropdown can escape overflow constraints
                    dropdown.style.position = 'absolute';
                    dropdown.style.zIndex = '10001';
                    dropdown.style.maxHeight = '300px';
                    dropdown.style.overflowY = 'auto';
                    dropdown.style.overflowX = 'hidden';
                    
                    // Make wrapper allow overflow for dropdown
                    wrapper.style.overflow = 'visible';
                    wrapper.style.zIndex = '10000';
                    
                    // Ensure all options are visible and not clipped
                    const ensureOptionsVisible = function() {
                        const options = dropdown.querySelectorAll('.custom-select-option');
                        options.forEach(function(option) {
                            option.style.display = 'flex';
                            option.style.visibility = 'visible';
                            option.style.opacity = '1';
                            option.style.flexShrink = '0';
                            option.style.minHeight = '44px';
                        });
                    };
                    
                    // Check when dropdown opens
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                                if (dropdown.classList.contains('open')) {
                                    ensureOptionsVisible();
                                    // Scroll selected option into view
                                    const selected = dropdown.querySelector('.custom-select-option.selected');
                                    if (selected) {
                                        selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                                    }
                                }
                            }
                        });
                    });
                    
                    observer.observe(dropdown, { attributes: true });
                    ensureOptionsVisible();
                }
            }
        }, 300);
    }
});
</script>

<style>
/* Schedule Page */
.schedule-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 32px 64px;
}

.schedule-navigation {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
    margin-bottom: 32px;
    padding: 20px;
    background: var(--color-layer);
    border: 1px solid var(--color-layer-border);
    border-radius: 16px;
}

.schedule-nav-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 12px;
    background: var(--color-layer-soft);
    border: 1px solid var(--color-layer-border);
    color: var(--color-text-primary);
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
}

.schedule-nav-btn:hover {
    background: rgba(255, 127, 0, 0.1);
    border-color: rgba(255, 127, 0, 0.3);
    color: var(--color-accent);
}

.schedule-month-selector {
    display: flex;
    align-items: center;
    justify-content: center;
}

.schedule-month-display {
    padding: 12px 20px;
    border-radius: 12px;
    background: var(--color-layer-soft);
    border: 1px solid var(--color-layer-border);
    color: var(--color-text-primary);
    font-size: 1rem;
    font-weight: 600;
    text-align: center;
}

/* Light mode styling for month display */
body[data-theme='light'] .schedule-month-display {
    color: #000000;
}

.schedule-list {
    display: grid;
    gap: 24px;
    margin-top: 24px;
}

.schedule-date-group {
    border-bottom: 1px solid var(--color-layer-border);
    padding-bottom: 24px;
}

.schedule-date-group:last-child {
    border-bottom: none;
}

.schedule-date-header {
    margin-bottom: 16px;
}

.schedule-date-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.schedule-day-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--color-text-primary);
}

.schedule-date-full {
    font-size: 0.95rem;
    color: var(--color-text-subtle);
}

.schedule-games {
    display: grid;
    gap: 16px;
    margin-left: 24px;
}

.schedule-game-item {
    display: flex;
    gap: 24px;
    padding: 16px;
    border-radius: 12px;
    background: var(--color-layer-soft);
    border: 1px solid var(--color-layer-border);
    transition: all 0.3s ease;
}

.schedule-game-item:hover {
    border-color: rgba(255, 127, 0, 0.3);
    background: rgba(255, 127, 0, 0.05);
}

.schedule-game-time {
    min-width: 100px;
    font-weight: 600;
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
}

.schedule-game-details {
    flex: 1;
    display: grid;
    gap: 8px;
}

.schedule-game-matchup {
    display: flex;
    align-items: center;
    gap: 12px;
}

.schedule-vs-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
}

.schedule-vs-badge.home {
    background: rgba(255, 127, 0, 0.2);
    color: var(--color-accent);
}

.schedule-vs-badge.away {
    background: rgba(100, 100, 100, 0.2);
    color: var(--color-text-secondary);
}

.schedule-opponent-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.schedule-game-venue {
    font-size: 0.9rem;
    color: var(--color-text-subtle);
    display: flex;
    align-items: center;
    gap: 6px;
}

.schedule-game-status {
    display: flex;
    align-items: center;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-final, .status-game-over {
    background: rgba(100, 100, 100, 0.2);
    color: var(--color-text-secondary);
}

.status-in-progress, .status-pre-game {
    background: rgba(255, 127, 0, 0.2);
    color: var(--color-accent);
}

.schedule-game-pitchers {
    font-size: 0.85rem;
    color: var(--color-text-subtle);
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Calendar Widget Styles */
.schedule-calendar-container {
    margin-top: 24px;
    margin-bottom: 32px;
    width: 100%;
}

.calendar-widget {
    margin-top: 20px;
    width: 100%;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 8px;
}

.calendar-weekday {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-subtle);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 8px 4px;
}

.calendar-days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 3px 3px 3px 3px;
    border-radius: 8px;
    background: var(--color-layer-soft);
    border: 1px solid var(--color-layer-border);
    position: relative;
    transition: all 0.2s ease;
    min-height: 48px;
    overflow: hidden;
}

.calendar-day.other-month {
    opacity: 0.3;
}

.calendar-day.today {
    background: rgba(255, 127, 0, 0.2);
    border: 2px solid var(--color-accent);
    border-color: var(--color-accent);
    font-weight: 700;
    box-shadow: 0 0 0 2px rgba(255, 127, 0, 0.3), 0 2px 8px rgba(255, 127, 0, 0.4);
    position: relative;
}

.calendar-day.today::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border: 2px solid var(--color-accent);
    border-radius: 8px;
    opacity: 0.5;
    pointer-events: none;
}

.calendar-day.today .calendar-day-number {
    font-weight: 800;
    font-size: 0.85rem;
    color: var(--color-accent);
}

.calendar-day.has-game {
    cursor: pointer;
}

.calendar-day.has-game:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.calendar-day.has-game.game-home {
    background: rgba(255, 127, 0, 0.15);
    border-color: rgba(255, 127, 0, 0.4);
}

.calendar-day.has-game.game-away {
    background: rgba(100, 150, 255, 0.15);
    border-color: rgba(100, 150, 255, 0.4);
}

.calendar-day.has-game.today.game-home {
    background: rgba(255, 127, 0, 0.3);
    border: 2px solid var(--color-accent);
    box-shadow: 0 0 0 2px rgba(255, 127, 0, 0.4), 0 2px 8px rgba(255, 127, 0, 0.5);
}

.calendar-day.has-game.today.game-away {
    background: rgba(100, 150, 255, 0.3);
    border: 2px solid var(--color-accent);
    box-shadow: 0 0 0 2px rgba(255, 127, 0, 0.4), 0 2px 8px rgba(255, 127, 0, 0.5);
}

.calendar-day-number {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
    z-index: 1;
    align-self: flex-start;
    width: 100%;
    text-align: left;
    padding-left: 2px;
    line-height: 1;
}

.calendar-team-logo {
    width: 24px;
    height: 24px;
    max-width: 24px;
    max-height: 24px;
    object-fit: contain;
    z-index: 2;
    opacity: 1;
    display: block;
    align-self: center;
    margin-top: auto;
    flex-shrink: 0;
}

/* Larger logos on schedule page */
.schedule-page .calendar-team-logo {
    width: 48px;
    height: 48px;
    max-width: 48px;
    max-height: 48px;
}

.calendar-game-indicator {
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.65rem;
    color: var(--color-accent);
    z-index: 1;
}

.calendar-legend {
    display: flex;
    gap: 20px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--color-layer-border);
    justify-content: center;
}

.calendar-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: var(--color-text-subtle);
}

.calendar-legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    border: 1px solid;
}

.calendar-legend-home {
    background: rgba(255, 127, 0, 0.15);
    border-color: rgba(255, 127, 0, 0.4);
}

.calendar-legend-away {
    background: rgba(100, 150, 255, 0.15);
    border-color: rgba(100, 150, 255, 0.4);
}

.schedule-list-title {
    margin-top: 32px;
    margin-bottom: 16px;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-text-primary);
}

/* Light mode styling for month header */
body[data-theme='light'] .schedule-page .panel-header h2 {
    color: #000000;
}

/* Schedule page dropdown styling */
.schedule-page .section-hero {
    overflow: visible;
    position: relative;
}

.schedule-page .section-hero-actions {
    overflow: visible;
    position: relative;
    z-index: 1;
}

.schedule-page .gameday-user-picker .custom-select-wrapper {
    position: relative !important;
    overflow: visible !important;
    z-index: 10000 !important;
}

.schedule-page .gameday-user-picker .custom-select-dropdown {
    position: absolute !important;
    z-index: 10001 !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    overscroll-behavior: contain !important;
}

.schedule-page .gameday-user-picker .custom-select-option {
    flex-shrink: 0 !important;
    min-height: 44px !important;
}

/* Ensure scrollbar is visible on schedule page dropdown */
.schedule-page .gameday-user-picker .custom-select-dropdown {
    scrollbar-width: thin !important;
    scrollbar-color: var(--color-text-subtle) var(--color-layer-soft) !important;
}

.schedule-page .gameday-user-picker .custom-select-dropdown::-webkit-scrollbar {
    width: 8px !important;
    display: block !important;
    -webkit-appearance: none !important;
}

.schedule-page .gameday-user-picker .custom-select-dropdown::-webkit-scrollbar-track {
    background: var(--color-layer-soft) !important;
    border-radius: 4px !important;
}

.schedule-page .gameday-user-picker .custom-select-dropdown::-webkit-scrollbar-thumb {
    background: var(--color-text-subtle) !important;
    border-radius: 4px !important;
    min-height: 20px !important;
}

.schedule-page .gameday-user-picker .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-secondary) !important;
}
</style>
{% endblock %}

